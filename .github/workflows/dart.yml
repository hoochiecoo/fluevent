on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    - uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    - run: flutter pub get

    - name: Force Extract Native Libs & Remove Icons
      run: |
        sed -i '/android:icon/d' android/app/src/main/AndroidManifest.xml
        sed -i '/android:roundIcon/d' android/app/src/main/AndroidManifest.xml
        sed -i 's/<application/<application android:extractNativeLibs="true"/g' android/app/src/main/AndroidManifest.xml

    - name: Download and Setup OpenCV 4.12.0
      run: |
        echo "Downloading OpenCV..."
        wget -q https://github.com/opencv/opencv/releases/download/4.12.0/opencv-4.12.0-android-sdk.zip
        unzip -q opencv-4.12.0-android-sdk.zip
        mv OpenCV-android-sdk opencv
        echo "Moving OpenCV libs to jniLibs..."
        mkdir -p android/app/src/main/jniLibs
        cp -r opencv/sdk/native/libs/* android/app/src/main/jniLibs/

    - name: Install Android NDK (for libc++_shared.so)
      env:
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
      run: |
        echo "Installing NDK..."
        yes | "$ANDROID_SDK_ROOT"/cmdline-tools/latest/bin/sdkmanager "ndk;26.1.10909125"
        echo "ANDROID_NDK_HOME set to: $ANDROID_SDK_ROOT/ndk/26.1.10909125"
        echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

    - name: Inject Standard C++ Library
      env:
        ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
      run: |
        set -e
        NDK_ROOT=$ANDROID_NDK_HOME
        echo "NDK Path: $NDK_ROOT"
        copy_stl() {
           ARCH_NAME=$1
           ABI_NAME=$2
           echo "--- Processing $ARCH_NAME ---"
           STL_FILE=$(find "$NDK_ROOT" -name "libc++_shared.so" | grep "/$ABI_NAME/" | head -n 1)
           if [ -z "$STL_FILE" ]; then
               echo "ERROR: libc++_shared.so not found for $ARCH_NAME!" >&2
               exit 1
           fi
           echo "Found: $STL_FILE"
           mkdir -p "android/app/src/main/jniLibs/$ARCH_NAME"
           cp "$STL_FILE" "android/app/src/main/jniLibs/$ARCH_NAME/"
        }
        copy_stl "arm64-v8a" "aarch64"
        copy_stl "armeabi-v7a" "arm-linux-androideabi"
        copy_stl "x86" "i686"
        copy_stl "x86_64" "x86_64"

    - run: flutter build apk --debug
    - uses: actions/upload-artifact@v4
      with:
        name: camera-app-debug
        path: build/app/outputs/flutter-apk/app-debug.apk
