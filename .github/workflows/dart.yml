on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    - uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    - run: flutter pub get

    - name: Download and Setup OpenCV 4.12.0
      run: |
        echo "Downloading OpenCV..."
        wget -q https://github.com/opencv/opencv/releases/download/4.12.0/opencv-4.12.0-android-sdk.zip
        unzip -q opencv-4.12.0-android-sdk.zip
        mv OpenCV-android-sdk opencv
        echo "Moving OpenCV libs to jniLibs..."
        mkdir -p android/app/src/main/jniLibs
        # Copy OpenCV shared libs (libopencv_java4.so per ABI)
        cp -r opencv/sdk/native/libs/* android/app/src/main/jniLibs/
        # Copy libc++_shared.so from OpenCV 3rdparty if present (covers most cases without NDK)
        if [ -d "opencv/sdk/native/3rdparty/libs" ]; then
          for abi in arm64-v8a armeabi-v7a x86 x86_64; do
            if [ -f "opencv/sdk/native/3rdparty/libs/$abi/libc++_shared.so" ]; then
              mkdir -p "android/app/src/main/jniLibs/$abi"
              cp "opencv/sdk/native/3rdparty/libs/$abi/libc++_shared.so" "android/app/src/main/jniLibs/$abi/"
            fi
          done
        fi

    - run: flutter build apk --debug
    - uses: actions/upload-artifact@v4
      with:
        name: camera-app-debug
        path: build/app/outputs/flutter-apk/app-debug.apk
