plugins {
    id "com.android.application"
    id "kotlin-android"
    id "dev.flutter.flutter-gradle-plugin"
}

def localProperties = new Properties()
def localPropertiesFile = rootProject.file('local.properties')
if (localPropertiesFile.exists()) {
    localPropertiesFile.withReader('UTF-8') { reader ->
        localProperties.load(reader)
    }
}

android {
    namespace "com.example.flutter_opencv_lab"
    compileSdkVersion 34
    ndkVersion "25.1.8937393" // Укажите установленную версию NDK

    defaultConfig {
        applicationId "com.example.flutter_opencv_lab"
        minSdkVersion 24 // CameraX требует минимум 21, лучше 24+
        targetSdkVersion 34
        versionCode flutterVersionCode.toInteger()
        versionName flutterVersionName

        // ✅ Ограничиваем архитектуру только arm64
        ndk {
            abiFilters "arm64-v8a"
        }
        
        // ✅ C++ флаги
        externalNativeBuild {
            cmake {
                cppFlags "-std=c++17 -fvisibility=hidden"
                arguments "-DANDROID_STL=c++_shared"
            }
        }
    }

    // ✅ Подключение CMake
    externalNativeBuild {
        cmake {
            path "src/main/cpp/CMakeLists.txt"
            version "3.22.1"
        }
    }

    buildTypes {
        release {
            signingConfig signingConfigs.debug
            minifyEnabled true // R8 оптимизация
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
    
    // CameraX зависимости
    dependencies {
        def camerax_version = "1.3.1"
        implementation "androidx.camera:camera-core:${camerax_version}"
        implementation "androidx.camera:camera-camera2:${camerax_version}"
        implementation "androidx.camera:camera-lifecycle:${camerax_version}"
        implementation "androidx.camera:camera-view:${camerax_version}"
    }
}

flutter {
    source '../..'
}
